<div class="profile-container container mt-4">
  <!-- Show loading indicator if still loading -->
  <div *ngIf="isLoading()" class="text-center py-3">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading profile...</span>
    </div>
  </div>

  <!-- Display error message if any -->
  <div *ngIf="error()" class="alert alert-danger">
    {{ error() }}
  </div>

  <!-- Display success message if any -->
  <div *ngIf="successMessage()" class="alert alert-success">
    {{ successMessage() }}
  </div>

  <div *ngIf="!isLoading()" class="profile-header d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
      <app-user-image [userName]="username" size="large"></app-user-image>
      <div class="ms-3">
        <h3>{{ username }}</h3>
        <!-- Only show email for own profile -->
        <p *ngIf="isOwnProfile" class="text-muted">{{ email }}</p>
      </div>
    </div>
    <!-- Only show settings button for own profile -->
    <button *ngIf="isOwnProfile" class="btn btn-outline-secondary" (click)="editMode = !editMode">
      <i class="bi bi-gear"></i> Impostazioni
    </button>
  </div>

    <!-- ModalitÃ  modifica - only visible for own profile -->
    <div *ngIf="editMode && isOwnProfile" class="mt-4 mb-5">
      <hr />
      <div class="profile-edit-section px-3 py-4 rounded shadow-sm bg-light">
        <h4 class="mb-4 border-bottom pb-2">Edit Profile</h4>
    
        <form [formGroup]="profileForm" (ngSubmit)="updateProfile()">
          <div class="row g-3">
            <!-- Username -->
            <div class="col-md-6">
              <label for="username" class="form-label">Username</label>
              <input
                id="username"
                formControlName="username"
                type="text"
                class="form-control"
                [class.is-invalid]="profileForm.get('username')?.invalid && profileForm.get('username')?.touched"
              />
              <div class="invalid-feedback" *ngIf="profileForm.get('username')?.errors?.['required']">
                Required field
              </div>
            </div>
    
            <!-- Email -->
            <div class="col-md-6">
              <label for="email" class="form-label">Email</label>
              <input
                id="email"
                formControlName="email"
                type="email"
                class="form-control"
                [class.is-invalid]="profileForm.get('email')?.invalid && profileForm.get('email')?.touched"
              />
              <div class="invalid-feedback" *ngIf="profileForm.get('email')?.errors?.['required']">
                Required field
              </div>
              <div class="invalid-feedback" *ngIf="profileForm.get('email')?.errors?.['email']">
                Invalid email
              </div>
            </div>
    
            <!-- Old Password -->
            <div class="col-md-6">
              <label for="oldPassword" class="form-label">Old Password</label>
              <input
                id="oldPassword"
                formControlName="oldPassword"
                type="password"
                class="form-control"
              />
            </div>
    
            <!-- New Password -->
            <div class="col-md-6">
              <label for="newPassword" class="form-label">New Password</label>
              <input
                id="newPassword"
                formControlName="newPassword"
                type="password"
                class="form-control"
              />
            </div>
    
            <!-- Confirm Password -->
            <div class="col-md-6">
              <label for="confirmPassword" class="form-label">Confirm New Password</label>
              <input
                id="confirmPassword"
                formControlName="confirmPassword"
                type="password"
                class="form-control"
              />
            </div>
    
            <!-- Checkboxes in col-12 -->
            <div class="col-12">
              <div class="form-check mb-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="consentData"
                  formControlName="consentData"
                />
                <label class="form-check-label" for="consentData">
                  I consent to the collection of my data
                </label>
              </div>
    
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="consentSuggestions"
                  formControlName="consentSuggestions"
                />
                <label class="form-check-label" for="consentSuggestions">
                  I agree to receive personalized suggestions
                </label>
              </div>
            </div>
            <!-- Buttons -->
            <div class="col-12 mt-4">
              <div *ngIf="!confirmDelete">
                <button type="submit" class="btn btn-primary me-2" [disabled]="profileForm.invalid">
                  Save Changes
                </button>
                <button type="button" class="btn btn-outline-danger" (click)="confirmDelete = true">
                  Delete Account
                </button>
              </div>
            
              <div *ngIf="confirmDelete" class="alert alert-warning mt-3">
                <p><strong>Are you sure you want to delete your account?</strong> This action cannot be undone.</p>
              
                <div class="mb-3">
                  <label for="deletePassword" class="form-label">Enter your password to confirm:</label>
                  <input
                    id="deletePassword"
                    type="password"
                    class="form-control"
                    [(ngModel)]="deletePassword"
                    [ngModelOptions]="{ standalone: true }"
                    name="deletePassword"
                    required
                  />
                </div>
              
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-danger" (click)="deleteAccount()">Confirm Deletion</button>
                  <button type="button" class="btn btn-secondary" (click)="confirmDelete = false">Cancel</button>
                </div>
              </div>
            </div>  
          </div>
        </form>
      </div>
    </div>
    

  <!-- Sezioni con tab -->
  <ul ngbNav #nav="ngbNav" [(activeId)]="activeId" class="nav nav-tabs mb-3">
    <li [ngbNavItem]="1">
      <a ngbNavLink>Cocktail personalizzati</a>
      <ng-template ngbNavContent>
        <div class="row">
          <div>
            <app-cocktails-grid [createdByUsername]="profileUsername" [onlyCreatedBy]="true" [loggedIn]="isAuthenticated"></app-cocktails-grid>
          </div>
        </div>
      </ng-template>
    </li>

    <li [ngbNavItem]="2">
      <a ngbNavLink>Cocktail Preferiti</a>
      <ng-template ngbNavContent>
        <div class="row">
          <div>
            <app-cocktails-grid [favoriteUsername]="profileUsername" [onlyFavorites]="true" [loggedIn]="isAuthenticated"></app-cocktails-grid>
          </div>
        </div>
      </ng-template>
    </li>

    <li [ngbNavItem]="3">
      <a ngbNavLink>Recensioni</a>
      <ng-template ngbNavContent>
        <div class="row">
          <div class="col-md-12">
        
            <!-- Loading spinner -->
            <div *ngIf="reviewsLoading" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading reviews...</span>
              </div>
            </div>
        
            <!-- Error message -->
            <div *ngIf="reviewsError" class="alert alert-danger">
              {{ reviewsError }}
            </div>
        
            <!-- Reviews list -->
            <div *ngIf="!reviewsLoading && !reviewsError">
              <div *ngIf="reviews.length === 0" class="text-center py-4">
                <p class="text-muted">No reviews found for this user.</p>
              </div>
        
              <div *ngIf="reviews.length > 0" class="reviews-list">
                <app-review-card
                  *ngFor="let review of reviews"
                  [review]="review"
                  [currentUserName]="loggedInUsername"
                  [ratingOptions]="ratingOptions"
                  [showPlaceCocktail]="true"
                  (refreshParent)="loadUserReviews()">
                </app-review-card>
              </div>
            </div>
          </div>
        </div>        
      </ng-template>
    </li>
  </ul>

  <div [ngbNavOutlet]="nav" class="mt-3"></div>
</div>
