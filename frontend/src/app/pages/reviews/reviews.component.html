<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <button class="btn btn-outline-secondary" (click)="navigateToPlace()">
      ← Back to Place
    </button>
    <button class="btn btn-outline-secondary" (click)="navigateToCocktail()">
      ← Back to Cocktail
    </button>
  </div>

  <!-- Loading state -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Error message -->
  <div *ngIf="errorMessage" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <!-- Content when loaded -->
  <div *ngIf="!loading && !errorMessage" class="reviews-content">
    <!-- Place Details Section -->
    <div class="place-details text-center">
      <div class="photo-container mx-auto">
        <div *ngIf="placeLoading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading image...</span>
          </div>
        </div>
        
        <div *ngIf="placeError || !place" class="no-photo">
          <p>Place details not available</p>
        </div>
        
        <a *ngIf="!placeLoading && !placeError && place && placePhotoUrl && place.geometry && place.geometry.location" 
           [href]="'https://maps.google.com/?q=' + place.geometry.location.lat + ',' + place.geometry.location.lng"
           target="_blank">
          <img [src]="placePhotoUrl" class="img-fluid rounded" alt="{{ place.name || 'Place' }}">
        </a>
        
        <a *ngIf="!placeLoading && !placeError && place && placePhotoUrl && (!place.geometry || !place.geometry.location)" 
           href="javascript:void(0)">
          <img [src]="placePhotoUrl" class="img-fluid rounded" alt="{{ place.name || 'Place' }}">
        </a>
        
        <div *ngIf="!placeLoading && !placeError && place && !placePhotoUrl" class="no-photo">
          <p>No image available</p>
        </div>
      </div>
      
      <h2 class="mt-3 mb-2">{{ place?.name || 'Unknown Place' }}</h2>
      <p class="text-muted mb-4">{{ place?.formatted_address || 'No address available' }}</p>
    </div>

    <!-- Cocktail Details Section -->
    <div class="cocktail-details text-center mt-4">
      <h3 class="mb-3">Cocktail Details</h3>
      
      <div *ngIf="cocktailLoading" class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading cocktail...</span>
        </div>
      </div>
      
      <div *ngIf="cocktailError || !cocktail" class="alert alert-warning">
        <p>Cocktail details not available</p>
      </div>
      
      <div *ngIf="!cocktailLoading && !cocktailError && cocktail" class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
          <div class="cocktail-image-container mb-3">
            <img *ngIf="cocktail.strDrinkThumb" 
                 [src]="cocktail.strDrinkThumb" 
                 class="img-fluid rounded cocktail-image" 
                 alt="{{ cocktail?.strDrink || 'Cocktail' }}">
            
            <div *ngIf="!cocktail.strDrinkThumb" class="no-photo">
              <p>No image available</p>
            </div>
          </div>
          
          <h4>{{ cocktail?.strDrink || 'Unknown Cocktail' }}</h4>
          <p *ngIf="cocktail?.strCategory" class="text-muted">Category: {{ cocktail.strCategory }}</p>
          <p *ngIf="cocktail?.strAlcoholic" class="text-muted">{{ cocktail.strAlcoholic }}</p>
        </div>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="reviews-section mt-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="m-0">Reviews</h3>
        <button class="btn btn-primary" (click)="toggleReviewForm()">
          {{ showReviewForm ? 'Cancel' : 'Add Review' }}
        </button>
      </div>
      
      <!-- Review Form -->
      <div *ngIf="showReviewForm" class="review-form card mb-4">
        <div class="card-body">
          <h4 class="card-title mb-3">Write a Review</h4>
          
          <div *ngIf="reviewSuccess" class="alert alert-success">
            Your review has been submitted successfully! Reloading...
          </div>
          
          <div *ngIf="reviewError" class="alert alert-danger">
            {{ reviewError }}
          </div>
          
          <form (ngSubmit)="submitReview()" #reviewForm="ngForm">
            <div class="mb-3">
              <label for="rating" class="form-label">Rating</label>
              <div class="rating-selector">
                <div class="star-rating">
                  <button 
                    type="button" 
                    *ngFor="let rating of ratingOptions" 
                    class="star-btn"
                    [class.selected]="isSelectedRating(rating)"
                    (click)="setRating(rating)">
                    <span class="star">★</span>
                  </button>
                </div>
                <span class="ms-3 rating-display">
                  <span class="stars">{{ newReview.rating }}/5</span>
                </span>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="comment" class="form-label">Comment</label>
              <textarea 
                class="form-control" 
                id="comment" 
                rows="4" 
                [(ngModel)]="newReview.comment" 
                name="comment" 
                required
                placeholder="Share your experience with this cocktail at this place..."></textarea>
            </div>
            
            <div class="text-end">
              <button 
                type="submit" 
                class="btn btn-primary" 
                [disabled]="submittingReview || !newReview.comment.trim()">
                <span *ngIf="submittingReview" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Submit Review
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <div *ngIf="reviews.length === 0" class="text-center py-4">
        <p class="text-muted">No reviews found for this cocktail at this place.</p>
      </div>
      
      <div *ngIf="reviews.length > 0" class="reviews-list">
        <div *ngFor="let review of reviews" class="card mb-3 review-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="d-flex align-items-center user-profile-link">
                <div (click)="navigateToUserProfile(review.userName)" class="d-flex align-items-center">
                  <app-user-image [userName]="review.userName" size="small" class="me-2 clickable"></app-user-image>
                  <h5 class="card-title mb-0 clickable">{{ review.userName || 'Anonymous' }}</h5>
                </div>
              </div>
              <div class="d-flex align-items-center">
                <!-- Edit and Delete buttons (only for author) -->
                <div *ngIf="isReviewAuthor(review)" class="review-actions me-3">
                  <button 
                    class="btn btn-sm btn-outline-primary me-2" 
                    (click)="startEditReview(review)"
                    [disabled]="isEditing && editingReviewId === review.id">
                    Edit
                  </button>
                  <button 
                    class="btn btn-sm btn-outline-danger" 
                    (click)="startDeleteReview(review.id)"
                    [disabled]="showDeleteConfirm && deletingReviewId === review.id">
                    Delete
                  </button>
                </div>
                <span class="text-muted small">{{ getFormattedDate(review.createdAt) }}</span>
              </div>
            </div>
            
            <!-- Regular review display (when not editing) -->
            <div *ngIf="!(isEditing && editingReviewId === review.id)">
              <div class="rating mb-3">
                <span class="stars">{{ getStarRating(review.rating) }}</span>
                <span class="rating-value ms-2">{{ review.rating }}/5</span>
              </div>
              
              <p class="card-text review-comment">{{ review.comment || 'No comment' }}</p>
            </div>
            
            <!-- Edit form (when editing) -->
            <div *ngIf="isEditing && editingReviewId === review.id" class="edit-review-form">
              <div *ngIf="reviewSuccess" class="alert alert-success">
                Your review has been updated successfully! Reloading...
              </div>
              
              <div *ngIf="reviewError" class="alert alert-danger">
                {{ reviewError }}
              </div>
              
              <form (ngSubmit)="saveEditReview()">
                <div class="mb-3">
                  <label class="form-label">Rating</label>
                  <div class="rating-selector">
                    <div class="star-rating">
                      <button 
                        type="button" 
                        *ngFor="let rating of ratingOptions" 
                        class="star-btn"
                        [class.selected]="isEditRatingSelected(rating)"
                        (click)="setEditRating(rating)">
                        <span class="star">★</span>
                      </button>
                    </div>
                    <span class="ms-3 rating-display">
                      <span class="stars">{{ editReview.rating }}/5</span>
                    </span>
                  </div>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">Comment</label>
                  <textarea 
                    class="form-control" 
                    rows="4" 
                    [(ngModel)]="editReview.comment" 
                    name="editComment" 
                    required
                    placeholder="Share your experience with this cocktail at this place..."></textarea>
                </div>
                
                <div class="text-end">
                  <button type="button" class="btn btn-outline-secondary me-2" (click)="cancelEditReview()">
                    Cancel
                  </button>
                  <button 
                    type="submit" 
                    class="btn btn-primary" 
                    [disabled]="submittingReview || !editReview.comment?.trim()">
                    <span *ngIf="submittingReview" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Save Changes
                  </button>
                </div>
              </form>
            </div>
            
            <!-- Delete confirmation -->
            <div *ngIf="showDeleteConfirm && deletingReviewId === review.id" class="delete-confirm mt-3">
              <div class="alert alert-danger">
                <p>Are you sure you want to delete this review? This action cannot be undone.</p>
                <div class="d-flex justify-content-end">
                  <button type="button" class="btn btn-outline-secondary me-2" (click)="cancelDeleteReview()">
                    Cancel
                  </button>
                  <button 
                    type="button" 
                    class="btn btn-danger" 
                    [disabled]="deletingReview"
                    (click)="confirmDeleteReview()">
                    <span *ngIf="deletingReview" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 